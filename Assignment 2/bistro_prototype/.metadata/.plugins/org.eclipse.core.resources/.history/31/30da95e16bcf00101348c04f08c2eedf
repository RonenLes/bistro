package server;

import ocsf.server.*;
import java.io.IOException;
import java.net.InetAddress;
import requests.*;
import responses.ErrorResponse;
import controllers.ReservationController;

import java.io.IOException;

public class BistroEchoServer extends AbstractServer  {

    private final ReservationController reservationController;

    public BistroEchoServer(int port) {
        super(port);
        reservationController = new ReservationController();
    }

    @Override
    protected void handleMessageFromClient(Object msg, ConnectionToClient client) {

        try {
            Object response = null;

            if (msg instanceof ReservationRequest) {
                ReservationRequest request = (ReservationRequest) msg;
                response = reservationController.addReservation(request);
            }
            else if (msg instanceof EditReservationRequest) {
                EditReservationRequest request = (EditReservationRequest) msg;
                response = reservationController.editReservation(request);
            }
            else if (msg instanceof ShowDataRequest) {
                ShowDataRequest request = (ShowDataRequest) msg;

                if (request.getCommandType() == CommandType.READ_ALL_EXISTING_RESERVATIONWS) {
                    response = reservationController.fetchAllReservations();
                }
                else if (request.getCommandType() == CommandType.READ_RESERVATIONS_BY_CODE) {
                    response = reservationController.fetchReservationsByConfirmationCode(request.getCode());
                }
            }
            else {
                response = new ErrorResponse("Unknown request type received");
            }

            // Always send back a response if it exists
            if (response != null)
                client.sendToClient(response);

        } catch (Exception e) {
            System.err.println("Server Error while handling client request: " + e.getMessage());
            try {
                client.sendToClient(new ErrorResponse("Server encountered an error while processing your request."));
            } catch (IOException ex) {
                System.err.println("Failed to send error response to client.");
            }
        }
    }
}
