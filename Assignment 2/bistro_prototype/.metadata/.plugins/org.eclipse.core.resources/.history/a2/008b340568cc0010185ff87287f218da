package db;

import java.sql.*;
import java.util.List;
import java.util.ArrayList;
import entities.Reservation;
import java.time.LocalDate;


public class ReservationDB {

	private DBManager dbManager;
	
	//INSERT statement
	private static final String INSERT_newReservation = "INSERT INTO `reservations` " + 
														"(reservationID, reservationDate, numberOfGuests, confirmationCode, subscriberId, dateOfPlacingOrder) "+
														"VALUES (?, ?, ?, ?, ?, ?)";
	
	//SELECT statements
	private static final String SELECT_AllOrders = "SELECT * FROM `reservations`";
	private static final String SELECT_OrdersByDate = "SELECT * FROM `reservations` WHERE reservationDate = ?";
	private static final String SELECT_ByID = "SELECT COUNT(*) FROM reservations WHERE reservationID = ?";
	private static final String SELECT_howManyUniqueCodes = "SELECT COUNT(*) FROM reservations WHERE confirmationCode = ?";
	
	// UPDATE statement
	private static final String UPDATE_Guests_ByOrder = "UPDATE reservations SET numberOfGuests = ? WHERE reservationID = ?";
	private static final String UPDATE_Date_ByOrder ="UPDATE `reservations` SET reservationDate = ? WHERE reservationID = ?";



	public ReservationDB() {
		this.dbManager = DBManager.getInstance();
	}
	
	
	/**
	 * method to insert new reservation into the database
	 * @param reservationID
	 * @param reservationDate
	 * @param numberOfGuests
	 * @param confirmationCode
	 * @param subscriberId
	 * @param dateOfPlacingOrder
	 * @return true if new reservation successfully added 
	 * @throws SQLException
	 */
	// updated reservationID to long for unique 10 digit id
	public boolean insertNewReservation(long reservationID,LocalDate reservationDate,int numberOfGuests,int confirmationCode,int subscriberId,LocalDate dateOfPlacingOrder) throws SQLException {
		
		java.sql.Date sqlReservationDate = java.sql.Date.valueOf(reservationDate);
		java.sql.Date sqlPlacingReservationDate = java.sql.Date.valueOf(dateOfPlacingOrder);
		
		try {
			Connection conn = dbManager.getConnection();
			PreparedStatement pstmt = conn.prepareStatement(INSERT_newReservation);
			
			//insert the details we got from control into statement
			pstmt.setLong(1, reservationID);
			pstmt.setDate(2,sqlReservationDate);
			pstmt.setInt(3, numberOfGuests);
			pstmt.setInt(4,confirmationCode);
			pstmt.setInt(5,subscriberId);
			pstmt.setDate(6, sqlPlacingReservationDate);
			
			int isInserted = pstmt.executeUpdate();
			return isInserted==1; //return 'true' if indeed new reservation added and only 1 row was affected
			
		}catch(SQLException e) {
			System.err.println("Database error: could not insert new reservation");
			throw e;
		}	
	}
	
	public boolean updateNumberOfGuests(int orderNumber, int newGuestAmount) throws SQLException {
	    try (Connection conn = dbManager.getConnection();
	         PreparedStatement pstmt = conn.prepareStatement(UPDATE_Guests_ByOrder)) {

	        pstmt.setInt(1, newGuestAmount);
	        pstmt.setInt(2, orderNumber);

	        int rows = pstmt.executeUpdate();
	        return rows == 1;  // true only if exactly one row was updated
	    } catch (SQLException e) {
	        System.err.println("Database error: could not update number of guests");
	        throw e;
	    }
	}
	public boolean updateOrderDate(int orderNumber, Date newDate) throws SQLException {
	    try (Connection conn = dbManager.getConnection();
	         PreparedStatement pstmt = conn.prepareStatement(UPDATE_Date_ByOrder)) {

	        pstmt.setDate(1, newDate);
	        pstmt.setInt(2, orderNumber);

	        int rows = pstmt.executeUpdate();
	        return rows == 1;  // true only if exactly one row was updated
	    } catch (SQLException e) {
	        System.err.println("Database error: could not update number of guests");
	        throw e;
	    }
	}

	/**
	 * method to read all the reservations in the data base and put them in a list for ReservaionControl
	 * @return list of all existing reservations
	 * @throws SQLException
	 */
	public List<Reservation> readAllReservations() throws SQLException{
		
		List<Reservation> reservationsList = new ArrayList<>();
		
		try {
			Connection conn = dbManager.getConnection();
			Statement stmt = conn.createStatement();
			ResultSet rs = stmt.executeQuery(SELECT_AllOrders);
			
			while(rs.next()) {
				
				java.sql.Date sqlReservationDate = rs.getDate("reservationDate");
				java.sql.Date sqlPlacingReservationDate = rs.getDate("dateOfPlacingOrder");
				
				Reservation res = new Reservation(
						rs.getInt("reservationID"),
						sqlReservationDate.toLocalDate(),
						rs.getInt("numberOfGuests"),
						rs.getInt("confirmationCode"),
						rs.getInt("subscriberId"),
						sqlPlacingReservationDate.toLocalDate()
				);
				
				reservationsList.add(res);
			}
		}catch(SQLException e) {
			System.err.println("Database error: could not fetch orders");
			throw e;
		}
		return reservationsList;
	}
	
	/**
	 * 
	 * @param date of the desired reservation
	 * @return list of reservation of the desired date
	 * @throws SQLException
	 */
	public List<Reservation> readReservationsByDate(Date date) throws SQLException{
		
		List<Reservation> reservationsList = new ArrayList<>();
		
		try {
			
			Connection conn = dbManager.getConnection();
			PreparedStatement pstmt = conn.prepareStatement(SELECT_OrdersByDate);
			pstmt.setDate(1, date);
			ResultSet rs = pstmt.executeQuery();
			
			while(rs.next()) {
				
				java.sql.Date sqlReservationDate = rs.getDate("reservationDate");
				java.sql.Date sqlPlacingReservationDate = rs.getDate("dateOfPlacingOrder");
				
				Reservation res = new Reservation(
						rs.getInt("reservationID"),
						sqlReservationDate.toLocalDate(),
						rs.getInt("numberOfGuests"),
						rs.getInt("confirmationCode"),
						rs.getInt("subscriberId"),
						sqlPlacingReservationDate.toLocalDate()
				);
				
				reservationsList.add(res);
			}			
			
		}catch(SQLException e) {
			System.err.println("Database error: could not fetch orders by date");
			throw e;
		}
		
		return reservationsList;
	}
	
	/**
	 * Checks the database to see if a given reservationID already exists.
	 * @param id The 10-digit ID to check (long).
	 * @return true if the ID exists, false otherwise.
	 * @throws SQLException if a database access error occurs.
	 */
	public boolean isReservationIdExist(int id) throws SQLException {
	    try {
	        Connection conn = dbManager.getConnection();
	        PreparedStatement pstmt = conn.prepareStatement(SELECT_ByID);
	        pstmt.setInt(1, id);
	       
	    }
	}
	
	public boolean isConfirmationCodeUsed(int confirmationCode) throws SQLException {
		
		try {
			Connection conn = dbManager.getConnection();
			PreparedStatement pstmt = conn.prepareStatement(SELECT_howManyUniqueCodes);
			pstmt.setInt(1,confirmationCode);
			ResultSet rs=pstmt.executeQuery();
			
			if(rs.next()) {
				int count = rs.getInt(1);
				return count >0;
			}
		}catch(SQLException e) {
			System.err.println("Database error counting unique codes");
			throw e;
		}
		return false;
	}
	
}
