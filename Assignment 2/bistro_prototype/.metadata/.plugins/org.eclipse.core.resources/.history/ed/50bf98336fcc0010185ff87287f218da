package controllers;

import db.ReservationDB;
import entities.Reservation;
import requests.EditReservationRequest;
import requests.ReservationRequest;
import responses.ReservationResponse;
import responses.ShowDataResponse;

import java.sql.Date;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;

public class ReservationController {

   

   private ReservationDB reservationDB;
	
    
    private ReservationController() {
    	reservationDB = new ReservationDB();
    }

    /**
     * server uses this method to read all the reservations and send them to the client as an object
     * containing all information  
     * @return ShowDataResponse object 
     */
    public ShowDataResponse fetchAllReservations()  {
        List<Reservation> reservationsList = new ArrayList<>();
        
        try {
        	reservationsList = this.reservationDB.readAllReservations();
        	return new ShowDataResponse(true, reservationsList, "Successfully fetched " + reservationsList.size() + " Reservations.");
        }catch(SQLException e) {
        	System.err.println("Database error: failed to fetch all reservations");
        	return new ShowDataResponse(false, null, "Database Error: Could not load reservation list.");
        }
                           
    }

 
    public ReservationResponse editReservation(EditReservationRequest request) {
    	
    	try {
    		boolean isEdited = reservationDB.updateReservation(request.getDinersToChange(), request.getDateToChange(), request.getConfirmationCode());
    		
    		if(isEdited) {
    			return new ReservationResponse(true, "successfully edited", request.getConfirmationCode());
    		}else {
    			return new ReservationResponse(false, "failed to edit", request.getConfirmationCode());
    		}
    	}catch(SQLException e) {
    		System.err.println("failed adding new reservation");
    		return new ReservationResponse(false,"failed to interact with database", -1);
    	}
    }
    
    /**
     * method to insert new order into the database based on the detail filled by the client in the ReservationRequest object
     * 
     * @param request 
     * @return ReservationResponse object
     * @throws SQLException
     */
    public ReservationResponse addReservation(ReservationRequest request) throws SQLException {
    	
    	int newId = generateReservationID();
    	int newCode = generateConfirmationCode();
    	
    	try {
    		boolean isInsertSuccess = reservationDB.insertNewReservation(newId
    				, request.getDateofRequest(), request.getDinersCount(), newCode, request.getCustomerInfo(), request.getDateOfPlacingRequest());
    		
    		if(isInsertSuccess) {
    			return new ReservationResponse(true, "Reservation is successful", newCode);
    		}else {
    			return new ReservationResponse(false, "Reservation failed", -1);
    		}
    	}catch(SQLException e) {
    		System.err.println("failed adding new reservation");
    		return new ReservationResponse(false,"failed to interact with database", -1);
    	}    	   	        
    }
    
    
    /**
     * method to generate a new unique code for addReservation to use
     * @return confirmationCode
     * @throws SQLException
     */
    private int generateConfirmationCode() throws SQLException {
    	int code;
    	
    	do {
    		Random rand = new Random();
    		code = 100000 + rand.nextInt(900000);
    	}while(reservationDB.isConfirmationCodeUsed(code));
    	return code;
    }
    
    
    /**
     * method to generate a new reservationID code for addReservation to use
     * @return reservationID
     * @throws SQLException
     */
    private int generateReservationID() throws SQLException {
    	int id;
    	
    	do {
    		Random rand = new Random();
    		id = 100000 + rand.nextInt(900000);
    	}while(reservationDB.isReservationIdExist(id));
    	return id;
    }
}
